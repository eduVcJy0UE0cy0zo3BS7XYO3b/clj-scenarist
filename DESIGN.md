# Дизайн-документ: Браузерный движок визуальных новелл (NVL стиль)

## Обзор проекта

### Цель
Создание легковесного браузерного движка для визуальных новелл, имитирующего классический NVL стиль NScripter, с использованием DataScript для управления состоянием игры.

### Ключевые особенности
- Полностью работает в браузере без серверной части
- NVL режим отображения текста (текст поверх изображения)
- Декларативное управление состоянием через DataScript
- Поддержка базовых функций визуальных новелл

## Архитектура

### Технологический стек
- **DataScript**: Управление состоянием игры и сценарием
- **ClojureScript**: Основной язык разработки
- **Reagent**: React-обертка для UI
- **Shadow-cljs**: Система сборки

### Компоненты системы

```
┌─────────────────────────────────────────┐
│            Пользовательский UI           │
│         (Reagent Components)             │
└─────────────────────┬───────────────────┘
                      │
┌─────────────────────┴───────────────────┐
│           Game Engine Core               │
│    (Обработка команд, переходы)          │
└─────────────────────┬───────────────────┘
                      │
┌─────────────────────┴───────────────────┐
│          DataScript Database             │
│    (Состояние игры, сценарий)           │
└─────────────────────────────────────────┘
```

## Схема данных DataScript

### Основные сущности

```clojure
;; Сцена
{:db/id          :scene/id
 :scene/name     "chapter1_intro"
 :scene/bg       "images/backgrounds/school.jpg"
 :scene/music    "audio/bgm/daily.mp3"
 :scene/lines    [{:db/id :line/id}...]}

;; Строка текста
{:db/id          :line/id
 :line/text      "Текст диалога..."
 :line/speaker   "Имя персонажа"
 :line/position  1
 :line/effects   [:effect/fade-in]}

;; Состояние игры
{:db/id                :game/state
 :game/current-scene   :scene/id
 :game/current-line    0
 :game/text-speed      :medium
 :game/auto-mode       false
 :game/history         [...]}

;; Сохранение
{:db/id          :save/id
 :save/slot      1
 :save/date      #inst "2024-01-15"
 :save/scene     :scene/id
 :save/line      5
 :save/thumbnail "data:image/png;base64,..."}
```

## UI/UX дизайн

### NVL режим отображения

```
┌─────────────────────────────────────────┐
│                                         │
│         [Фоновое изображение]           │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │                                   │  │
│  │  Имя персонажа                   │  │
│  │  ─────────────                   │  │
│  │  Первая строка диалога...        │  │
│  │                                   │  │
│  │  Вторая строка диалога...        │  │
│  │                                   │  │
│  │  Третья строка диалога...        │  │
│  │                                   │  │
│  └───────────────────────────────────┘  │
│                                         │
│  [Меню] [Сохранить] [Загрузить] [Опции]│
└─────────────────────────────────────────┘
```

### Стилизация
- Полупрозрачный фон для текста (rgba(0,0,0,0.7))
- Шрифт: Gothic/Mincho стиль для аутентичности
- Плавное появление текста посимвольно
- Анимация перехода между сценами

## Основные функции

### 1. Движок сценария
```clojure
(defn process-script-command [db command]
  (case (:type command)
    :show-text    (add-line-to-scene db command)
    :change-bg    (update-background db command)
    :play-music   (trigger-music-change db command)
    :choice       (create-choice-branch db command)
    :jump         (change-scene db command)))
```

### 2. Система сохранений
- Автосохранение в localStorage
- Множественные слоты сохранений
- Превью сохранений с миниатюрами

### 3. Настройки
- Скорость текста (медленно/средне/быстро/мгновенно)
- Громкость музыки/звуков
- Авто-режим чтения
- Пропуск прочитанного текста

### 4. История диалогов
- Прокручиваемый лог всех диалогов
- Возможность вернуться к предыдущим выборам

## Формат сценария

### Пример структуры сценария
```clojure
{:scenes
 [{:id :intro
   :background "school_entrance.jpg"
   :music "daily_life.mp3"
   :content
   [{:type :text
     :speaker "Рассказчик"
     :text "Обычное утро в старшей школе..."}
    {:type :text
     :speaker "Главный герой"
     :text "Снова опаздываю на занятия."}
    {:type :choice
     :text "Что делать?"
     :options
     [{:text "Бежать в класс" :jump :classroom}
      {:text "Пойти в библиотеку" :jump :library}]}]}]}
```

## План разработки

### Фаза 1: Базовый движок
- [ ] Настройка проекта (shadow-cljs, deps.edn)
- [ ] Базовая схема DataScript
- [ ] Компонент отображения NVL текста
- [ ] Система переходов между сценами

### Фаза 2: Расширенные функции
- [ ] Система сохранений
- [ ] Меню настроек
- [ ] История диалогов
- [ ] Поддержка выборов

### Фаза 3: Полировка
- [ ] Анимации и эффекты
- [ ] Оптимизация производительности
- [ ] Поддержка мобильных устройств
- [ ] Экспорт/импорт сценариев

## Структура проекта

```
scm-scenarist/
├── deps.edn              # Зависимости
├── shadow-cljs.edn       # Конфигурация сборки
├── src/
│   ├── scenarist/
│   │   ├── core.cljs     # Точка входа
│   │   ├── db.cljs       # DataScript схема
│   │   ├── engine.cljs   # Игровой движок
│   │   ├── ui/           # React компоненты
│   │   │   ├── nvl.cljs
│   │   │   ├── menu.cljs
│   │   │   └── saves.cljs
│   │   └── script.cljs   # Парсер сценария
├── resources/
│   └── public/
│       ├── index.html
│       ├── css/
│       └── assets/       # Изображения, звуки
└── test/
```

## Производительность

### Оптимизации
- Ленивая загрузка ресурсов
- Предзагрузка следующей сцены
- Кеширование изображений
- Минимизация перерисовок React

### Ограничения
- Максимальный размер сценария: 10MB
- Поддержка форматов: JPEG, PNG, WebP, MP3, OGG
- Целевые браузеры: Chrome 90+, Firefox 88+, Safari 14+

## Безопасность
- Все данные хранятся локально в браузере
- Нет внешних запросов
- Валидация загружаемых сценариев
- CSP заголовки для защиты от XSS